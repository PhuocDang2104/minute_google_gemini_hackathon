# 2026-02-06 (AHT) – Tổng hợp cập nhật & hướng dẫn triển khai

Tài liệu này tổng hợp toàn bộ thay đổi đã làm trong chuỗi trao đổi gần đây, nhằm ổn định pipeline transcript → minutes và đồng bộ LLM theo MINUTE (Gemini Hackathon).

**1) Mục tiêu chính**
- Ổn định lưu video + metadata vào DB, tách storage thật (Supabase) khỏi DB (Aiven).
- Bổ sung migration còn thiếu để minutes/action/decision/risk/RAG hoạt động trên cloud.
- Chuẩn hóa LLM theo MINUTE (Gemini‑first, Groq fallback), đồng bộ prompt & các điểm gọi LLM.
- Tăng độ ổn định tạo minutes khi transcript dài (window‑summary + tổng hợp).

**2) Các thay đổi quan trọng**
- LLM Gemini‑first:
  - Đã thêm lớp gọi LLM thống nhất (Gemini‑first, Groq fallback) trong `backend/app/llm/gemini_client.py`.
  - Hỗ trợ SDK mới `google-genai` (fallback sang `google-generativeai` nếu chưa cài).
  - Các module in‑meeting, intent, RAG chain đã chuyển sang dùng `call_llm_sync` hoặc `GeminiChat`.
- Prompt & branding theo MINUTE:
  - Prompts in‑meeting, Q&A, ADR, recap được cập nhật theo MINUTE, thêm nhắc “multimodal/visual context”.
  - Chat homepage/context cập nhật lại theo idea proposal.
  - RAG prompt đổi sang MINUTE.
- Minutes generation bền vững hơn:
  - Transcript dài sẽ được chia window, summary từng đoạn rồi tổng hợp.
  - Các đoạn truy vấn DB trong minutes service đã rollback an toàn khi lỗi.
- Video metadata:
  - Thêm model + migration `meeting_recording`.
  - `video_service` lưu metadata + storage key + provider.
- Migration & schema:
  - Thêm bảng `meeting_minutes`, `minutes_distribution_log`.
  - Bổ sung cột mới cho `action_item`, `decision_item`, `risk_item`.
  - Thêm bảng `ask_ai_query`.
- Alembic:
  - Fix `alembic/env.py` để import `app` đúng khi chạy local.

**3) Danh sách file cập nhật**
- LLM & prompt:
  - `backend/app/llm/gemini_client.py`
  - `backend/app/llm/prompts/in_meeting_prompts.py`
  - `backend/app/llm/chains/in_meeting_chain.py`
  - `backend/app/llm/tools/smartbot_intent_tool.py`
  - `backend/app/llm/chains/rag_chain.py`
  - `backend/app/llm/README.md`
- API & service:
  - `backend/app/api/v1/endpoints/chat_http.py`
  - `backend/app/api/v1/endpoints/rag.py`
  - `backend/app/services/agenda_service.py`
  - `backend/app/services/knowledge_service.py`
  - `backend/app/services/minutes_service.py`
- Storage & DB:
  - `backend/app/services/video_service.py`
  - `backend/app/models/meeting_recording.py`
  - `backend/app/models/meeting.py`
  - `backend/alembic/env.py`
  - `backend/alembic/versions/9f2c4b1d7a1a_add_meeting_recording.py`
  - `backend/alembic/versions/e1b6c0a1d4c9_add_meeting_minutes_tables.py`
  - `backend/alembic/versions/c4a1b2d3e4f5_add_action_item_fields.py`
  - `backend/alembic/versions/f1a9b7c3d2e1_add_ask_ai_query.py`
- Dependency:
  - `backend/requirements.txt`
  - `requirements.txt`

**4) Migration cần chạy trên cloud DB**
Chạy trên instance backend (Render/Aiven):
```bash
export PYTHONPATH=.
alembic upgrade head
```

Nếu bị lỗi pool/connection:
- Giảm pool:
  - `DB_POOL_SIZE=1`
  - `DB_MAX_OVERFLOW=0`
  - `DB_POOL_TIMEOUT=30`
- Kill idle connections:
```sql
SELECT pg_terminate_backend(pid)
FROM pg_stat_activity
WHERE state = 'idle' AND usename = 'avnadmin';
```

**5) Supabase Storage**
- DB dùng Aiven; storage dùng Supabase S3.
- Env bắt buộc:
  - `SUPABASE_S3_ENDPOINT`
  - `SUPABASE_S3_REGION`
  - `SUPABASE_S3_BUCKET`
  - `SUPABASE_S3_ACCESS_KEY`
  - `SUPABASE_S3_SECRET_KEY`
- Lưu ý:
  - Nếu `file_url` là `/files/...` thì chỉ mở được trên backend host.
  - Nếu muốn frontend play video, cần dùng URL đầy đủ hoặc presigned URL.

**6) LLM env cần có**
- `GEMINI_API_KEY`
- `GEMINI_MODEL` (khuyến nghị `gemini-1.5-flash` hoặc `gemini-2.5-flash-lite`)
- `GROQ_API_KEY` (tuỳ chọn fallback)

**7) Quick smoke test**
```bash
curl -s https://<backend>/api/v1/chat/status
curl -s https://<backend>/api/v1/chat/test
```

**8) Known issues còn tồn tại**
- `decision_item.title` NOT NULL nhưng tạo decision chỉ set `description`. Cần migration relax/rename hoặc cập nhật query.
- Một số bảng `knowledge_document`/`knowledge_chunk` chưa có migration nếu bật full RAG.
- Presigned URL cho video có TTL; nếu muốn “xem lại mãi”, cần cache URL hoặc public bucket.
- Aiven free tier dễ full connection → bắt buộc pool nhỏ và kill idle.

**9) Next steps đề xuất**
- Hoàn thiện migration cho `decision_item.title`.
- Chuẩn hoá LLM router theo stage (pre/in/post) + chọn model theo latency.
- Bổ sung `visual_context` từ video/frame vào recap và summary.
